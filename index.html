<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Iniciar Sesi√≥n - Bookshop</title>
    <link rel="stylesheet" href="estilos.css">
    <!-- TensorFlow.js y modelos (carga desde CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.min.js"></script>

    <!-- MediaPipe FaceMesh + helpers desde jsDelivr -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script defer src="main.js"></script>
</head>
<body>
  <div class="container">
    <div class="form-container">
      <h1>Bookshop</h1>
      <h2>Inicio de sesi√≥n</h2>

      <button onclick="iniciarEscaneoFacial()">Iniciar escaneo facial</button>

      <a href="registro.html">
        <button>üë§ Registrarme</button>
      </a>

      <form id="manualLoginForm" style="display: none; margin-top: 20px;">
        <label>Correo:</label>
        <input type="email" name="correo" required />

        <label>Contrase√±a:</label>
        <input type="password" name="contrasena" required />

        <button type="submit">Ingresar</button>
      </form>
    </div>

        <div class="camera-wrapper">
            <div class="camera-container">
                <video id="video" width="320" height="240" autoplay muted></video>
                <canvas id="overlay"></canvas>
            </div>
  		    <div id="detection-status" style="text-align: center; font-weight: bold; margin: 10px 0; font-size: 16px;">
		        ‚è≥ Iniciando detecci√≥n...
		    </div>
            <p class="note">*Vea directamente a la c√°mara para el escaneo facial. Si no es posible, use su correo y contrase√±a.</p>
        </div>
        <!-- Segunda pantalla: formulario de correo (inicialmente oculto) -->
      <div id="emailLoginScreen" style="display: none;">
        <form id="manualLoginForm">
          <div class="input-group">
            <label>Correo:</label>
            <input type="email" name="correo" required placeholder="example@example.com" />
            <div class="input-note">Consejo/Inicio Con</div>
          </div>

          <div class="input-group">
            <label>Contrase√±a:</label>
            <input type="password" name="contrasena" required />
            <div class="input-note">Ingresa tu contrase√±a</div>
          </div>

          <div class="button-group">
            <button type="button" class="btn-back" onclick="goBackToSelection()">Volver</button>
            <button type="submit" class="btn-login">Iniciar Sesi√≥n</button>
          </div>
        </form>
      </div>
  </div>

  <script>
    // Funci√≥n para iniciar escaneo facial (ya implementada en main.js)
    function iniciarEscaneoFacial() {
      // La funci√≥n est√° implementada en main.js
      console.log("Iniciando escaneo facial...");
    }

    // Funci√≥n para mostrar formulario manual
    function mostrarFormulario() {
      document.querySelector('.form-container').style.display = 'none';
      document.querySelector('.camera-wrapper').style.display = 'none';
      document.getElementById('emailLoginScreen').style.display = 'block';
    }

    // Funci√≥n para volver a la selecci√≥n inicial
    function goBackToSelection() {
      document.querySelector('.form-container').style.display = 'block';
      document.querySelector('.camera-wrapper').style.display = 'block';
      document.getElementById('emailLoginScreen').style.display = 'none';
    }

    // Manejar login manual con formulario
    document.getElementById('emailLoginScreen').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const correo = formData.get('correo').trim();
      const contrasena = formData.get('contrasena').trim();

      if (!correo || !contrasena) {
        alert('Por favor complete todos los campos');
        return;
      }

      try {
        if (!db) await initIndexedDB();

        const userData = await getFaceData(correo);
        if (!userData) {
          alert('Usuario no encontrado');
          return;
        }

        if (userData.contrasena === contrasena) {
          // Login exitoso
          sessionStorage.setItem('currentUser', JSON.stringify({
            correo: userData.correo,
            nombre: userData.nombre,
            apellido: userData.apellido,
            telefono: userData.telefono,
            fotoRegistro: userData.fotoRegistro,
            fechaRegistro: userData.fechaRegistro,
            fechaRegistroFormateada: userData.fechaRegistroFormateada,
            loginTime: new Date().toISOString()
          }));

          // Tambi√©n guardar en localStorage para persistencia
          localStorage.setItem('loggedUser', JSON.stringify({
            correo: userData.correo,
            nombre: userData.nombre,
            apellido: userData.apellido,
            telefono: userData.telefono,
            fotoRegistro: userData.fotoRegistro,
            fechaRegistro: userData.fechaRegistro,
            fechaRegistroFormateada: userData.fechaRegistroFormateada,
            loginTime: new Date().toISOString()
          }));

          window.location.href = "bienvenido.html";
        } else {
          alert('Contrase√±a incorrecta');
        }

      } catch (error) {
        console.error('Error en login manual:', error);
        alert('Error al iniciar sesi√≥n: ' + error.message);
      }
    });
  </script>
</body>
</html>
